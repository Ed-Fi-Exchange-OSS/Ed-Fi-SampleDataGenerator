using System.Linq;
using EdFi.SampleDataGenerator.Core.DataGeneration.Common;
using FluentValidation;

namespace EdFi.SampleDataGenerator.Core.Config
{
    public interface ISampleDataGeneratorConfig
    {
        int? BatchSize { get; }
        string DataFilePath { get; }
        string OutputPath { get; }
        string SeedFilePath { get; }
        OutputMode OutputMode { get; }
        bool CreatePerformanceFile { get; }

        ITimeConfig TimeConfig { get; }

        IDistrictProfile[] DistrictProfiles { get; }
        IStudentProfile[] StudentProfiles { get; }

        IDataFileConfig DataFileConfig { get; }

        IEthnicityMapping[] EthnicityMappings { get; }
        IGenderMapping[] GenderMappings { get; }

        IStudentPopulationProfile[] StudentPopulationProfiles { get; }

        IGraduationPlanTemplate[] GraduationPlanTemplates { get; }

        IMutatorConfigurationCollection MutatorConfig { get; }

        IStudentGradeRange[] StudentGradeRanges { get; }
    }

    public class SampleDataGeneratorConfigValidator : AbstractValidator<ISampleDataGeneratorConfig>
    {
        public SampleDataGeneratorConfigValidator()
        {
            RuleFor(x => x.TimeConfig)
                .NotEmpty()
                .WithMessage("Time config must be defined");

            RuleFor(x => x.TimeConfig)
                .SetValidator(x => new TimeConfigValidator());

            RuleFor(x => x.DistrictProfiles)
                .NotEmpty()
                .WithMessage("At least one DistrictProfile must be defined");

            RuleForEach(x => x.DistrictProfiles)
                .SetValidator(x => new DistrictProfileValidator(x));

            RuleFor(x => x.StudentProfiles)
                .NotEmpty()
                .WithMessage("At least one StudentProfile must be defined");

            RuleForEach(x => x.StudentProfiles)
                .SetValidator(x => new StudentProfileValidator(x));

            RuleForEach(x => x.StudentProfiles)
                .Must(UseValidRaceOptions)
                .WithMessage((config, profile) =>
                    $"Student Profile '{profile.Name}' contains an invalid Race configuration option");

            RuleForEach(x => x.StudentProfiles)
                .Must(UseValidGenderOptions)
                .WithMessage((config, profile) =>
                    $"Student Profile '{profile.Name}' contains an invalid Sex configuration option");

            RuleForEach(x => x.GraduationPlanTemplates)
                .SetValidator(x => new GraduationPlanTemplateValidator());

            RuleFor(x => x.EthnicityMappings)
                .NotEmpty()
                .WithMessage("EthnicityMappings must be defined");

            RuleFor(x => x.GenderMappings)
                .NotEmpty()
                .WithMessage("GenderMappings must be defined");

            RuleFor(x => x.MutatorConfig)
                .SetValidator(x => new MutatorConfigurationValidator());
        }

        private bool UseValidRaceOptions(ISampleDataGeneratorConfig config, IStudentProfile profile)
        {
            var raceConfig = profile.RaceConfiguration;
            return raceConfig != null
                   && raceConfig.AttributeGeneratorConfigurationOptions
                                .All(o => config.IsValidRaceOption(o.Value));
        }

        private bool UseValidGenderOptions(ISampleDataGeneratorConfig config, IStudentProfile profile)
        {
            var genderConfig = profile.SexConfiguration;
            return genderConfig != null
                   && genderConfig.AttributeGeneratorConfigurationOptions
                                  .All(o => config.IsValidGenderOption(o.Value));
        }
    }

    public static class SampleDataGeneratorConfigHelpers
    {
        public static double GetMutationProbability(this ISampleDataGeneratorConfig config, string mutatorName)
        {
            var mutator = config.MutatorConfig.Mutators.FirstOrDefault(a => a.Name == mutatorName);
            return mutator?.Probability ?? 0;
        }
    }
}
